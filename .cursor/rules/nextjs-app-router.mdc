---
alwaysApply: false
---

# Next.js App Router 開発ルール

このドキュメントは、Next.js App Routerを使用したアプリケーション開発のベストプラクティスとルールを定義します。フォルダ構成、コーディング規約、パフォーマンス最適化までをカバーしています。

## ベストプラクティス

```javascript
const nextjsAppRouterBestPractices = [
  "デフォルトでサーバーコンポーネントを使用する",
  "必要な場合のみクライアントコンポーネントを実装する",
  "新しいファイルベースのルーティングシステムを活用する",
  "共有レイアウトにはlayout.jsを使用する",
  "ローディング状態の表示にはloading.jsを実装する",
  "エラーハンドリングにはerror.jsを使用する",
  "APIルートにはルートハンドラーを活用する",
];
```

## フォルダ構成

```
app/
  layout.js          # ルートレイアウト
  page.js            # ルートページ
  components/        # 共通コンポーネント
  lib/              # ユーティリティ関数やヘルパー
  styles/           # スタイルファイル
public/             # 静的ファイル
```

## 開発ガイドライン

### 1. TypeScriptの使用

- 型安全性のため、**TypeScriptを必ず使用する**
- すべてのコンポーネントと関数に適切な型定義を行う

### 2. メタデータの実装

- SEO対策のため、適切なメタデータを実装する
- `metadata` オブジェクトまたは `generateMetadata` 関数を使用する

### 3. 画像の最適化

- 画像には必ず **Next.js Image コンポーネント**を使用する
- 適切な `width`、`height`、`alt` 属性を指定する

### 4. スタイリング

- **CSS Modules** または **Tailwind CSS** を使用する
- インラインスタイルは最小限に抑える

### 5. エラーバウンダリ

- 適切なエラーバウンダリを実装する
- `error.js` ファイルでエラーハンドリングを行う

### 6. 命名規則

- Next.jsの特殊ファイルの命名規則に従う
  - `page.js` - ページコンポーネント
  - `layout.js` - レイアウトコンポーネント
  - `loading.js` - ローディングUI
  - `error.js` - エラーUI
  - `route.js` - APIルートハンドラー

### 7. 環境変数

- 設定には環境変数を使用する
- クライアント側で使用する変数には `NEXT_PUBLIC_` プレフィックスを付ける

## パフォーマンス最適化

### コンポーネントの遅延読み込み

```javascript
import dynamic from "next/dynamic";

const DynamicComponent = dynamic(() => import("../components/HeavyComponent"), {
  loading: () => <p>読み込み中...</p>,
});
```

### 画像の最適化

- Next.js Image コンポーネントを使用して自動最適化を行う
- 適切な画像フォーマット（WebP、AVIF）を使用する

### クライアントサイドJavaScriptの最小化

- サーバーコンポーネントを優先的に使用する
- クライアントコンポーネント（'use client'）は必要な場合のみ使用する

### データフェッチングの最適化

- `fetch` のキャッシュ機能を活用する
- 並列データフェッチングで `Promise.all` を使用する
- ストリーミングとSuspenseを活用する

## テスト

### 単体テスト

- **Jest** と **React Testing Library** を使用する
- すべてのコンポーネントと関数に対してテストを記述する

### スナップショットテスト

- UIコンポーネントの一貫性を保証するためにスナップショットテストを実装する

### テストカバレッジ

- **最低80%のテストカバレッジ**を維持する
- 重要なビジネスロジックは100%カバーする

## ドキュメント

### JSDoc

- すべての関数とコンポーネントに **JSDoc** を記述する
- パラメータ、戻り値、型情報を明記する

```typescript
/**
 * ユーザー情報を取得する
 * @param {string} userId - ユーザーID
 * @returns {Promise<User>} ユーザーオブジェクト
 */
async function getUser(userId: string): Promise<User> {
  // 実装
}
```

### README

- 各主要ディレクトリに **README.md** を配置する
- プロジェクトの構造と使用方法を明記する

## エラーハンドリング

### グローバルエラーバウンダリ

- ランタイムエラーをキャッチするグローバルエラーバウンダリを実装する
- `app/error.js` でルートレベルのエラーを処理する

### 非同期処理

- すべての非同期操作に **try/catch ブロック**を使用する
- エラーは適切にログに記録し、ユーザーに分かりやすいメッセージを表示する

```typescript
try {
  const data = await fetchData();
  return data;
} catch (error) {
  console.error("データ取得エラー:", error);
  throw new Error("データの取得に失敗しました");
}
```

## サーバーコンポーネントとクライアントコンポーネント

### サーバーコンポーネント（デフォルト）

- データフェッチング
- バックエンドリソースへのアクセス
- 機密情報の保持（APIキーなど）
- 大きな依存関係をサーバーに保持

### クライアントコンポーネント（'use client'）

- インタラクティブ性の追加（onClick、onChangeなど）
- ステート管理（useState、useReducerなど）
- エフェクトの使用（useEffectなど）
- ブラウザAPIの使用
- カスタムフックの使用

## コーディング規約

1. **コンポーネントは小さく、単一責任を保つ**
2. **再利用可能なコンポーネントを作成する**
3. **プロップスには適切な型定義を行う**
4. **デフォルトプロップスを提供する**
5. **早期リターンでネストを減らす**
6. **魔法の数値や文字列は定数として定義する**
7. **コメントは「なぜ」を説明し、「何を」は避ける**
